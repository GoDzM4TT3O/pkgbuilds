--- ../../aur/linux-ck-upstream/PKGBUILD	2021-02-01 11:06:18.354808034 +0100
+++ PKGBUILD	2021-02-01 09:30:19.774337439 +0100
@@ -1,5 +1,6 @@
 # Maintainer: graysky <graysky AT archlinux DOT us>
 # Contributor: Jan Alexander Steffens (heftig) <jan.steffens@gmail.com>
+# Modified by Salonia Matteo <saloniamatteo@protonmail.com>
 
 ### BUILD OPTIONS
 # Set these variables to ANYTHING that is not null to enable them
@@ -49,7 +50,8 @@
 #  32. Generic-x86-64 (GENERIC_CPU)
 #  33. Native optimizations autodetected by GCC (MNATIVE)
 
-_subarch=
+# Haswell
+_subarch=23
 
 # Compile ONLY used modules to VASTLYreduce the number of modules built
 # and the build time.
@@ -59,7 +61,7 @@
 # This PKGBUILD read the database kept if it exists
 #
 # More at this wiki page ---> https://wiki.archlinux.org/index.php/Modprobed-db
-_localmodcfg=
+#_localmodcfg=
 
 ### IMPORTANT: Do no edit below this line unless you know what you're doing
 
@@ -85,20 +87,37 @@
   0002-HID-quirks-Add-Apple-Magic-Trackpad-2-to-hid_have_sp.patch
   0003-iwlwifi-Fix-regression-from-UDP-segmentation-support.patch
   0004-Revert-SUNRPC-Handle-TCP-socket-sends-with-kernel_se.patch
+  "modprobed.db"
+  "tune-config"
 )
 validpgpkeys=(
   'ABAF11C65A2970B130ABE3C479BE3E4300411886'  # Linus Torvalds
   '647F28654894E3BD457199BE38DBBDC86092693E'  # Greg Kroah-Hartman
 )
-b2sums=('f5e16e92c9543708997d9dfee28feb2cd6e6909a33dc7f97c40b507a8d03bd72717b1af84bed3fa25b2a167652d8cd93b66d145d484e5ad292af24b3bf64a649'
+b2sums=(
+        # Kernel source (linux-X.XX.X.tar.xz)
+        'f5e16e92c9543708997d9dfee28feb2cd6e6909a33dc7f97c40b507a8d03bd72717b1af84bed3fa25b2a167652d8cd93b66d145d484e5ad292af24b3bf64a649'
+        # Kernel source signature (linux-X.XX.X.tar.sign)
         'SKIP'
-        'a03b6ccb7e25ecbf1206043798de396e7feda398f625ff7163bce5c3d7f822fc7eca6ee59253526848a07806a19c102dd8706f24e9702c691bb26c70b7efb844'
+        # Kernel configuration (config)
+        '3f82d02edde8c354590bf86708089183283478df7065124d4a7e0c646914c530abdb5040bed2728a9e106a6ef2d45e89dc79bdcca99e179ed12ede98a8346d98'
+        # Enable additional CPU optimizations patch (enable_additional_cpu_optimizations-YYYYMMDD.tar.gz)
         '7f1eb5938472f57748216bd00e0c875feab99fc1c5cb89babfea467ee30ca5c8e9fc5a691efe2e602bef1ea79820c5383822d7cec354b48d23321ccda8ee8127'
+        # CK patchset (patch-X.XX-ck1.xz)
         '067f3389124fdd937ca69e9e9568b1b3194791960a093e81037051eb6d25e80b40bf7f60c61373ac9e92bff9db760766009b1e6f9ee8429a883bb7fce2d60f8a'
+        # 0001-ZEN-Add-sysctl-and-CONFIG-to-disallow-unprivileged-C.patch
         'de81e92b92ba697e472d6397faa425ebcc09bede6c97008dcae47efd341d2eaa12ec72209c4cc97155df01358e1fce3a86d3f0b5441ac91615037de72105defc'
+        # 0002-HID-quirks-Add-Apple-Magic-Trackpad-2-to-hid_have_sp.patch
         '9450bd3d4acfa94723eaf22f2c0a13ae3bdb1ceb15ad19d1a1de2fc8d9a7b9b8f759006fd5b4286da135c68bac75791b4bf767ece8b6c40aff95799296ee0327'
+        # 0003-iwlwifi-Fix-regression-from-UDP-segmentation-support.patch
         'ea8e11fa3e9ccffe26366c2c279e11ffd4cb7ed0500028afef083188d46a0df2487800417914e63b8ac101b6a28b6a61aad91bea0b7a0305d64be3445a4f68a0'
-        '4a40db184421fdda2b01efe22adee7a4e1ce82cbc877bfaea5aaaae7215d1fe9aeb307a5241af6b7b9e539ae3d1a26f35adaedce82c61d3edb60f6e0d1673743')
+        # 0004-Revert-SUNRPC-Handle-TCP-socket-sends-with-kernel_se.patch
+        '2486a3ff1307e8d0d5876b401b4358867563b1b3a6c92ebe12e7b1d08636891f1fae79b4ee89a228b2932c4c418cb4a4b5a1bb32d3522508a40617c7a7a7aff6'
+        # module database (modprobed.db)
+        '3e52ade633ffb1db3211aaa2058173482e1546fcc9ad66cd25ff56d6a9b1106fa185b8a578f4b753b146205dfc42bddb4e2d2055326eaaf8ee7178db2d1f5984'
+        # configuration modifier (tune-config)
+        'a789f3e75b0d03a00b5465f0dc480436d99bdb0421024b77976c0fb3da144d139090e57e7e557091b98371b201ceffc12d010d3c1c90ea2d5c3528ca63960ba2'
+)
 
 export KBUILD_BUILD_HOST=archlinux
 export KBUILD_BUILD_USER=$pkgbase
@@ -146,6 +165,9 @@
   # https://bugzilla.kernel.org/show_bug.cgi?id=207173#c6
   scripts/config --disable CONFIG_KVM_WERROR
 
+  # apply optimizations
+  ../tune-config
+
   # fix naming schema in EXTRAVERSION of ck patch set
   sed -i -re "s/^(.EXTRAVERSION).*$/\1 = /" "../${_ckpatch}"
 
@@ -170,17 +192,18 @@
     make oldconfig
   fi
 
-  ### Optionally load needed modules for the make localmodconfig
+  ### Load needed modules for the make localmodconfig
   # See https://aur.archlinux.org/packages/modprobed-db
-    if [ -n "$_localmodcfg" ]; then
-      if [ -f $HOME/.config/modprobed.db ]; then
-        echo "Running Steven Rostedt's make localmodconfig now"
-        make LSMOD=$HOME/.config/modprobed.db localmodconfig
-      else
-        echo "No modprobed.db data found"
-        exit
-      fi
-    fi
+  echo "Running Steven Rostedt's make localmodconfig now"
+
+  if [ -f "$HOME/.config/modprobed.db" ]; then
+    echo "Using modprobed.db in $HOME/.config! "
+    make LSMOD="$HOME/.config/modprobed.db" localmodconfig
+  else if [ -f "${srcdir}"/"modprobed.db" ]; then
+    echo "Using modprobed.db in ${pkgdir}! "
+    make LSMOD="${srcdir}/modprobed.db" localmodconfig
+  fi
+  fi
 
   make -s kernelrelease > version
   echo "Prepared $pkgbase version $(<version)"
@@ -196,7 +219,7 @@
 
 build() {
   cd linux-${pkgver}
-  make all
+  make all -j$(nproc)
 }
 
 _package() {
